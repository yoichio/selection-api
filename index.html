<!DOCTYPE html>
<html>
  <head>
    <title>FrameSelection API</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
        specStatus: "ED",
        shortName: "frameselection",
        editors: [
          {
            name: "Yoichi Osato",
            mailto: "yoichio@google.com",
            company: "Google Inc.",
            companyURL: "https://www.google.com/",
            w3cid: "49814",
          },
        ],
        wg: "Web Platform Working Group",
        wgURI: "https://www.w3.org/WebPlatform/WG/",
        wgPublicList: "public-webapps",
        wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83482/status",
        testSuiteURI: "TBD",
        github: "TBD",
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>
        This document is a preliminary draft of a specification for the FrameSelection API and selection related functionality.
        FrameSelection enables web authors to get/set selection
        considering <a href="https://www.w3.org/TR/dom41/#dom-element-attachshadow">Shadow DOM</a>.
      </p>
      <p>
	This document defines APIs for selection, which allows users and authors to select a portion of a document or specify a point of interest for copy, paste, and other editing operations.
      </p>
    </section>
    
    <section id='sotd'>
      <p>Any feedback or discussion of this specification should be sent to the
        <a href="mailto:public-webapps@w3.org">public-webapps mailing list</a>
        with "[selection-api]" as the Subject header prefix
        (<a href="https://lists.w3.org/Archives/Public/public-webapps/">archive</a>).
      </p>

      <p>
        This specification is based on the <a href="http://w3c.github.io/selection-api/">Selection API</a>
        edited by Ryosuke Niwa.
      </p>
    </section>

    <section class="informative">
      <h2>Background</h2>

      <p>Chrome69, Safari12 and Firefox64 support Shadow DOM.
        However, current Selection API specifies that there is single selection in a document and the selection is bound to
         single <a href="https://dom.spec.whatwg.org/#range">Range</a>, which can't represent a range crossing shadow boundary. <br>
        Chrome69 supports user selection crossing/inside shadow and copy/paste but web authors can't get the selected nodes through
        Selection API because of the limitation. document.getSelection() and shadowRoot.getSelection() only work well if selection is only inside each tree scope. <br>
        Safari12 supports user selection crossing/inside shadow and it doesn't support shadowRoot.getSelection(). <br>
        Firefox64 supports user selection inside shadow and it doesn't support shadowRoot.getSelection(). <br>
        Since current Selection API deeply depends on Range, it is hard to update existing Selection API following shadow tree.</p>

      <p>So I suggest new selection API that lets web authors to get/set user selection including shadow.</p>

      <p> Multiple range and selection reaction to DOM mutation is TBD.</p>

      <div class=note>
      <p>See <a href="https://github.com/w3c/webcomponents/issues/79">webcomponents issue 79</a> for more history and detail.</p>
      </div>
    </section>

    <section id='conformance'>
      <p>
        This specification defines conformance criteria that apply to a single
        product: the <dfn id="ua">user agent</dfn> that implements the
        interfaces that it contains.
      </p>
      <p>
        Implementations that use ECMAScript to implement the APIs defined in
        this specification must implement them in a manner consistent with the
        ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL-1]],
        as this specification uses that specification and terminology.
      </p>
    </section>

    <section>
      <h2>Definition</h2>

      <p>Every 
          <dfn><a href="https://html.spec.whatwg.org/multipage/window-object.html#the-window-object">window</a></dfn> ([[!HTML]])
         which associates a <dfn><a href="https://www.w3.org/TR/dom/#document">document</a></dfn> ([[!DOM]])
        in a <dfn><a href="https://www.w3.org/TR/html5/browsers.html#browsing-context">browsing context</a></dfn> ([[!HTML]])
        has a unique <dfn>selection</dfn> associated with it.</p>

      <p><dfn>Directional range</dfn> is range that has two <a href="https://www.w3.org/TR/dom/#concept-range-bp"><dfn>boundary point</dfn></a>s: <dfn>base</dfn> and <dfn>extent</dfn>.</p>
      <p class=note>base node and extent node can be in different node tree and no order consraint between them unlike DOM <dfn data-cite="!DOM#range">range</dfn>.</p>

      <p>This one <a>selection</a> must be shared by all the content of the <a>document</a> and its shadow tree
        (though not by nested <a>browsing context</a>s)</p>

      <p>Each <a>selection</a> can be associated with a single <a>directional range</a>.
          When there is no <a>directional range</a> associated with the <a>selection</a>, the </a>selection</a> is <dfn>empty</dfn>.
          The selection must be initially <a>empty</a>.</p>

    </section>

    <section data-dfn-for="DirectionalRange">
      <h2>DirectionalRange interface</h3>
      <p>DirectionalRange interface represents a <a>selection</a> range.</p>
      <pre class="idl">
        interface DirectionalRange {
          readonly attribute Node baseNode;
          readonly attribute unsigned long baseOffset;
          readonly attribute Node extentNode;
          readonly attribute unsigned long extentOffset;
          readonly attribute boolean isCollapsed;
        };
      </pre>
      <dl>
        <dt><dfn>baseNode</dfn></dt>
        <dd>
          <p>The attribute must return the <a>base</a> <dfn><a href="https://www.w3.org/TR/dom/#concept-node">node</a></dfn> ([[!DOM]])
          of the <dfn><a href="https://www.w3.org/TR/dom/#context-object">context object</a></dfn> ([[!DOM]]).
        </dd>

        <dt><dfn>baseOffset</dfn></dt>
        <dd>
          <p>The attribute must return the <a>base</a> <dfn><a href="https://www.w3.org/TR/dom/#concept-range-bp-offset">offset</a></dfn> ([[!DOM]])
          of the <a>context object</a>.</p>
        </dd>

        <dt><dfn>extentNode</dfn></dt>
        <dd>
          <p>The attribute must return the <a>extent</a> <a>node</a> of the <a>context object</a>.</p>
        </dd>

        <dt><dfn>extentOffset</dfn></dt>
        <dd>
          <p>The attribute must return the <a>extent</a> <a>offset</a> of the <a>context object</a>.</p>
        </dd>

        <dt><dfn>isCollapsed</dfn></dt>
        <dd>
          <p>The attribute must return true if and only if <a>context object</a>'s <a>base</a> equals <a>extent</a>. Otherwise it must return false.</p>
        </dd>
      </dl>
    </section>

    <section data-dfn-for="FrameSelection">
      <h2>FrameSelection interface</h2>
      <p>FrameSelection interface provides a way to interact with the <a>selection</a>
        associated with each window.
      </p>

      <pre class="idl">
        interface FrameSelection {
          DirectionalRange? getRange(optional sequence&lt;ShadowRoot&gt; disclosedShadows = []);
          void clear();
          void setBaseAndExtent(Node baseNode, unsigned long baseOffset, Node extentNode, unsigned long extentOffset);
        };
      </pre>
      <dl>
        <dt><dfn>getRange</dfn></dt>
        <dd>
          <p>The method must follow these steps.</p>
          <ol>
            <li>If <a>selection</a> is <a>empty</a>, return null. </li>
            <li> Let <var>range base node</var> and <var>range base offset</var> be <a>base</a> node and <a>base</a> offset.
              <ol>
                <li> Let node be range base node.</li>
                <li> If node's root is document, abort this step. </li>
                <li> The root must be ShadowRoot. If the root is in disclosedShadows, abort this step.</li>
                <li> If the root is closed ShadowRoot, let node be its host. Go back to step 2. </li>
                <li> Set  <var>range base node</var> be node and <var>range base offset</var> be 0. </li>
              </ol>              
            </li>
            <li> Ditto to <var>range extent node</var> and <var>range extent offset</var>.</li>
            <li>Return DirectionalRange of <var>range base node</var>, <var>range base offset</var>, <var>range extent node</var> and <var>range extent offset</var>. </li>
          </ol>
          <div class=note>
            If no closed ShadowRoot in document, getRange() must return exact <a>base</a> and <a>extent</a>.
            If there is a closed ShadowRoot ancestor of each node, this method adopts the host node of shadowest closed ShadowRoot.
            If web author has a reference of a closed ShadowRoot, getRange(closedRoot) return as the ShadowRoot is open.
          </div>
        </dd>

        <dt><dfn>clear</dfn></dt>
        <dd>
            <p>The method must make the <a>context object</a> <a>empty</a> by clearing 
              <a>context object</a>'s <a>base</a> and <a>extent</a>.</p>
        </dd>

        <dt><dfn>setBaseAndExtent</dfn></dt>
        <dd>
          <p>The method must set <a>context object</a>'s <a>directional range</a> following these steps:</p>
          <p>TBD</p>
          <!--ol>
            <li>If <var>baseOffset</var> is longer than <var>baseNode</var>'s <a>length</a>
              or if <var>extentOffset</var> is longer than <var>extentNode</var>'s <a>length</a>,
              throw an <a>IndexSizeError</a> exception and abort these steps.</li>
            <li>If the <a>root</a>s of <var>baseNode</var> or <var>extentNode</var> are not the <a>document</a> associated with <a>context object</a>,
              abort these steps.</li>
            <li>Let <var>base</var> be the <a>boundary point</a> (<var>baseNode</var>, <var>baseOffset</var>)
              and let <var>extent</var> be the <a>boundary point</a> (<var>extentNode</var>, <var>extentOffset</var>).</li>
            <li>Let <var>newRange</var> be a new <a>range</a>.</li>
            <li>If <var>base</var> is <a>before</a> <var>extent</var>,
              <a href="#range-set">set</a> the <var>newRange</var>'s <a href="#range-start">start</a> to <var>base</var>
              and its <a href="#range-end">end</a> to <var>extent</var>.
              Otherwise, <a href="#range-set">set</a> them to <var>extent</var> and <var>base</var> respectively.</li>
            <li>Set the <a>context object</a>'s <a>range</a> to <var>newRange</var>.</li>
            <li>If <var>extent</var> is <a>before</a> <var>base</var>, set <a>context object</a>'s <a>direction</a> to <a>backwards</a>.
              Otherwise, set it to <a>forwards</a></li>
          </ol -->
        </dd>
      </dl>

      
    </section>

    <section>
      <h2>Extensions to Other Interfaces</h2>

      <p>This specification extends several interfaces to provide entry points to the
      interfaces defined in this specification.</p>

      <section data-dfn-for="Window">
        <h3>Extensions to <code>Window</code> interface</h3>
        <pre class="idl">
          partial interface Window {
            FrameSelection ? getFrameSelection();
          };
        </pre>
        <dl>
          <dt><dfn>getFrameSelection()</dfn></dt>
          <dd>
            <p>The method must return the <a>selection</a> associated with <a>context object</a>
              if the <a>context object</a> has an associated <a>browsing context</a>,
              and it must return <code>null</code> otherwise.</p>
          </dd>
        </dl>
      </section>

      <section data-dfn-for="GlobalEventHandlers">
        <h3>Extensions to <code>GlobalEventHandlers</code></h3>
        <p>
          The <code><dfn>GlobalEventHandlers</dfn></code> interface is defined in [[!HTML]].
        </p>
        <p>TBD.</p>
      </section>

    </section>

    <section>
      <h2>User Interactions</h2>

      <p>The user agent should allow the user to change the <a>selection</a> associated with the <dfn>active document</dfn>
        (<a href="https://www.w3.org/TR/html5/browsers.html#active-document">defined</a> in [[!HTML]]).
        If the user makes any modification to a <a>selection</a>, <a>FrameSelection</a> must refer the updated <a>selection</a>.

      <p>The user agent must not make a <a>selection</a> <a>empty</a> if it was not already <a>empty</a>
        in response to any user actions (e.g. clicking on a non-editable region).</p>

    </section>

    <section class='appendix'>
      <h2>Acknowledgements</h2>
      <p>Many thanks to</p>
      <ul>
        <li><p>Ryosuke Niwa, who is the original author of <a href="http://w3c.github.io/selection-api/">Selection API</a>.</p></li>
        <li>TBD. </li>
    </section>

  </body>
</html>
